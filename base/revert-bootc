#!/bin/bash

# Revert the ostree-specific changes made in the Dockerfile, so that the image can be used
# in a standard installation.
# 
# This should only be run in a mutable installation context, not in an ostree-booted system.

set -x
source /usr/src/ultramarine-bootc/base/common.sh

# Remove symlinks created by bootc
rm -rf /opt /root /home /ostree /srv

# remove rechunk-prep action
rm -rf /etc/dnf/libdnf5-plugins/actions.d/rechunk-prep.actions
# delete dummy rpm database
rm -rf /usr/share/rpm

# Recreate the original directories
mkdir -p /home /root /usr/local /srv /opt

# Set proper permissions
chmod 0755 /home /opt /usr/local /srv
chmod 0700 /root

# Remove tmpfiles configuration
rm -rf /usr/lib/tmpfiles.d/bootc-base-dirs.conf

# Restore default useradd HOME setting
sed -i '/^HOME=\/var\/home$/d' /etc/default/useradd || true

# Comment out PackageKit ostree backend
sed -i 's/DefaultBackend=.*/#DefaultBackend=/' /etc/PackageKit/PackageKit.conf

KERNEL_VERSION=$(get_kernel_version)

# Reinstall the kernel to restore initramfs and grub entries
kernel-install add $KERNEL_VERSION /lib/modules/$KERNEL_VERSION/vmlinuz

rsync -av /usr/lib/ostree-boot/ /boot/

mkdir -p /boot/efi
# Copy EFI files
rsync -av /usr/lib/efi/*/*/EFI/ /boot/efi/EFI/

# copy GRUB files

rsync -av /usr/lib/grub/ /boot/grub2/
# Regenerate GRUB configuration
grub-mkconfig -o /boot/grub2/grub.cfg
grub2-editenv create
grub2-editenv set menu_auto_hide=0
