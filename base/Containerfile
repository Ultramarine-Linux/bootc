# Please build from the root directory of the repository

# todo: fix katsu docker build

FROM ghcr.io/fyralabs/katsu:main AS builder

WORKDIR /work

COPY . .

RUN --mount=type=cache,target=/var/cache \
    katsu -o folder base.yaml
# COPY --from=builder /target-rootfs/ /
# RUN rm -rf /boot/*

FROM scratch

COPY --from=builder /work/katsu-work/chroot /

RUN mkdir -p /sysroot/ostree
RUN ln -srvf /sysroot/ostree /ostree
# symlink rpmdb for ostree compatibility
# hack: rechunk needs this to be happy
RUN mv /usr/lib/sysimage/rpm /usr/share/rpm
# todo: should be the other way around, but rechunk hates this
RUN ln -srvf /usr/share/rpm /usr/lib/sysimage/rpm
# RUN ostree init --repo /sysroot/ostree/repo --mode bare
COPY prepare-root.conf /usr/lib/ostree/prepare-root.conf
RUN bootc container lint || true

LABEL containers.bootc 1
LABEL bootc.diskimage-builder quay.io/centos-bootc/bootc-image-builder
ENV container=oci
# Need to reference builder here to force ordering. But since we have to run
# something anyway, we might as well cleanup after ourselves.
STOPSIGNAL SIGRTMIN+3
CMD ["/sbin/init"]
