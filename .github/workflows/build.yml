name: Build bootc images
permissions: write-all

env:
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}

on:
  push:
    paths:
      # Update this when new tiers are added
      - "base/**"
      - "tier0/**"
      - "tier1/**"
      - "tier2/**"
      - ".github/workflows/**"
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 1 * * TUE" #Â Every Tuesday at 1am UTC
  merge_group:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # Detect which paths changed to enable incremental builds
  detect-changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      base: ${{ steps.filter.outputs.base }}
      tier0: ${{ steps.filter.outputs.tier0 }}
      tier1: ${{ steps.filter.outputs.tier1 }}
      tier2: ${{ steps.filter.outputs.tier2 }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            base:
              - 'base/**'
            tier0:
              - 'tier0/**'
            tier1:
              - 'tier1/**'
            tier2:
              - 'tier2/**'
            workflows:
              - '.github/workflows/**'

  build-base:
    needs: detect-changes
    # Build if base changed, or if workflows changed, or if scheduled/manual
    if: |
      needs.detect-changes.outputs.base == 'true' ||
      needs.detect-changes.outputs.workflows == 'true' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    with:
      image-name: ultramarine
      flavor: base

  # Fetch base image if we didn't build it
  fetch-base:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base]
    if: always() && !cancelled()
    outputs:
      manifest: ${{ steps.get-manifest.outputs.manifest }}
    steps:
      - name: Get manifest reference
        id: get-manifest
        run: |
          if [[ "${{ needs.build-base.result }}" == "success" ]]; then
            echo "manifest=${{ needs.build-base.outputs.manifest }}" >> $GITHUB_OUTPUT
          else
            # Fetch existing image by branch/tag name
            TAG="${GITHUB_REF_NAME}"
            echo "manifest=${{ env.IMAGE_REGISTRY }}/base-bootc:${TAG}" >> $GITHUB_OUTPUT
          fi

  # todo: maybe tier0 for desktop base images?
  #
  build-tier0:
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    needs: [detect-changes, fetch-base]
    if: |
      needs.detect-changes.outputs.base == 'true' ||
      needs.detect-changes.outputs.tier0 == 'true' ||
      needs.detect-changes.outputs.workflows == 'true' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        flavor:
          - desktop
    with:
      image-name: ultramarine-tier0
      flavor: ${{ matrix.flavor }}
      context-path: tier0/${{ matrix.flavor }}
      from: ${{ needs.fetch-base.outputs.manifest }}

  # Fetch tier0 images if we didn't build them
  fetch-tier0:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-tier0]
    if: always() && !cancelled()
    outputs:
      result: ${{ steps.get-result.outputs.result }}
    steps:
      - name: Get tier0 results
        id: get-result
        run: |
          if [[ "${{ needs.build-tier0.result }}" == "success" ]]; then
            echo 'result=${{ needs.build-tier0.outputs.result }}' >> $GITHUB_OUTPUT
          else
            # Build fallback JSON for existing images
            TAG="${GITHUB_REF_NAME}"
            RESULT=$(cat <<EOF
          {
            "manifest": {
              "desktop": "${{ env.IMAGE_REGISTRY }}/desktop-bootc:${TAG}"
            }
          }
          EOF
          )
            echo "result=$(echo $RESULT | jq -c .)" >> $GITHUB_OUTPUT
          fi

  tier0-outputs:
    needs: [fetch-tier0]
    runs-on: ubuntu-latest
    steps:
      - name: Pass through outputs
        id: read
        run: |
          echo 'result=${{ needs.fetch-tier0.outputs.result }}' >> $GITHUB_OUTPUT

    outputs:
      result: "${{ steps.read.outputs.result }}"

  build-tier1:
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    needs: [detect-changes, tier0-outputs]
    if: |
      needs.detect-changes.outputs.base == 'true' ||
      needs.detect-changes.outputs.tier0 == 'true' ||
      needs.detect-changes.outputs.tier1 == 'true' ||
      needs.detect-changes.outputs.workflows == 'true' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        flavor:
          - gnome
          - xfce
          - plasma
          - budgie
    with:
      image-name: ultramarine-tier1
      flavor: ${{ matrix.flavor }}
      context-path: tier1/${{ matrix.flavor }}
      from: ${{ fromJson(needs.tier0-outputs.outputs.result).manifest.desktop }}

  # Fetch tier1 images if we didn't build them
  fetch-tier1:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-tier1]
    if: always() && !cancelled()
    outputs:
      result: ${{ steps.get-result.outputs.result }}
    steps:
      - name: Get tier1 results
        id: get-result
        run: |
          if [[ "${{ needs.build-tier1.result }}" == "success" ]]; then
            echo 'result=${{ needs.build-tier1.outputs.result }}' >> $GITHUB_OUTPUT
          else
            # Build fallback JSON for existing images
            TAG="${GITHUB_REF_NAME}"
            RESULT=$(cat <<EOF
          {
            "manifest": {
              "gnome": "${{ env.IMAGE_REGISTRY }}/gnome-bootc:${TAG}",
              "xfce": "${{ env.IMAGE_REGISTRY }}/xfce-bootc:${TAG}",
              "plasma": "${{ env.IMAGE_REGISTRY }}/plasma-bootc:${TAG}",
              "budgie": "${{ env.IMAGE_REGISTRY }}/budgie-bootc:${TAG}"
            }
          }
          EOF
          )
            echo "result=$(echo $RESULT | jq -c .)" >> $GITHUB_OUTPUT
          fi

  tier1-outputs:
    needs: [fetch-tier1]
    runs-on: ubuntu-latest
    steps:
      - name: Pass through outputs
        id: read
        run: |
          echo 'result=${{ needs.fetch-tier1.outputs.result }}' >> $GITHUB_OUTPUT

    outputs:
      result: "${{ steps.read.outputs.result }}"

  # Extra tiers for HWE variants, etc.
  build-tier2:
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    needs: [detect-changes, tier1-outputs]
    if: |
      needs.detect-changes.outputs.base == 'true' ||
      needs.detect-changes.outputs.tier0 == 'true' ||
      needs.detect-changes.outputs.tier1 == 'true' ||
      needs.detect-changes.outputs.tier2 == 'true' ||
      needs.detect-changes.outputs.workflows == 'true' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        base-flavor:
          - gnome
          - xfce
          - plasma
          - budgie
        variant:
          # - surface
          # - nvidia
          # - rpi
          - steam
    with:
      image-name: ultramarine-tier2
      flavor: ${{ matrix.base-flavor }}
      context-path: tier2/${{ matrix.variant }}
      platforms: >-
        ${{
        matrix.variant == 'rpi' && 'linux/arm64' ||
        matrix.variant == 'steam' && 'linux/amd64' ||
        'linux/amd64,linux/arm64'
        }}
      from: ${{ fromJson(needs.tier1-outputs.outputs.result).manifest[matrix.base-flavor] }}
      tag-suffix: "-${{ matrix.variant }}"

  # Fetch tier2 images if we didn't build them
  fetch-tier2:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-tier2]
    if: always() && !cancelled()
    outputs:
      result: ${{ steps.get-result.outputs.result }}
    steps:
      - name: Get tier2 results
        id: get-result
        run: |
          if [[ "${{ needs.build-tier2.result }}" == "success" ]]; then
            echo 'result=${{ needs.build-tier2.outputs.result }}' >> $GITHUB_OUTPUT
          else
            # Tier2 images are optional variants, no fallback needed
            echo 'result={}' >> $GITHUB_OUTPUT
          fi

  tier2-outputs:
    needs: [fetch-tier2]
    runs-on: ubuntu-latest
    steps:
      - name: Pass through outputs
        id: read
        run: |
          echo 'result=${{ needs.fetch-tier2.outputs.result }}' >> $GITHUB_OUTPUT
    outputs:
      result: "${{ steps.read.outputs.result }}"
