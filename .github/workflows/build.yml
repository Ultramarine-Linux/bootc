name: Build bootc images
permissions: write-all

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 1 * * TUE" #Â Every Tuesday at 1am UTC
  merge_group:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-base:
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    with:
      image-name: ultramarine
      flavor: base

  # todo: maybe tier0 for desktop base images?
  #
  build-tier0:
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    needs: build-base
    strategy:
      fail-fast: false
      matrix:
        flavor:
          - desktop
    with:
      image-name: ultramarine-tier0
      flavor: ${{ matrix.flavor }}
      context-path: tier0/${{ matrix.flavor }}
      from: ${{ needs.build-base.outputs.manifest }}

  tier0-outputs:
    needs: [build-tier0]
    runs-on: ubuntu-latest
    steps:
      - uses: cloudposse/github-action-matrix-outputs-read@v1
        id: read
        with:
          matrix-step-name: ultramarine-tier0

    outputs:
      result: "${{ steps.read.outputs.result }}"

  build-tier1:
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    needs: [build-base, tier0-outputs]
    strategy:
      fail-fast: false
      matrix:
        flavor:
          - gnome
          - xfce
          - plasma
          - budgie
    with:
      image-name: ultramarine-tier1
      flavor: ${{ matrix.flavor }}
      context-path: tier1/${{ matrix.flavor }}
      from: ${{ fromJson(needs.tier0-outputs.outputs.result).manifest.desktop }}

  tier1-outputs:
    needs: [build-tier1]
    runs-on: ubuntu-latest
    steps:
      - uses: cloudposse/github-action-matrix-outputs-read@v1
        id: read
        with:
          matrix-step-name: ultramarine-tier1

    outputs:
      result: "${{ steps.read.outputs.result }}"
