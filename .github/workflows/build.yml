name: Build bootc images
permissions: write-all

env:
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}

on:
  push:
    paths:
      # Update this when new tiers are added
      - "base/**"
      - "tier0/**"
      - "tier1/**"
      - "tier2/**"
      - ".github/workflows/**"
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 1 * * TUE" #Â Every Tuesday at 1am UTC
  merge_group:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # Normalize environment variables for use across jobs
  normalize:
    runs-on: ubuntu-latest
    outputs:
      registry: ${{ steps.normalize.outputs.registry }}
      tag: ${{ steps.normalize.outputs.tag }}
    steps:
      - name: Normalize values
        id: normalize
        run: |
          # Convert IMAGE_REGISTRY to lowercase
          REGISTRY=$(echo ${{ env.IMAGE_REGISTRY }} | tr '[:upper:]' '[:lower:]')
          echo "registry=${REGISTRY}" >> $GITHUB_OUTPUT
          echo "Normalized registry: ${REGISTRY}"

          # Convert ref name to lowercase and replace slashes with dashes
          TAG=$(echo "${{ github.ref_name }}" | tr '[:upper:]' '[:lower:]' | tr '/' '-')
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Normalized tag: ${TAG}"

  # Detect which paths changed to enable incremental builds
  detect-changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      base: ${{ steps.filter.outputs.base }}
      tier0: ${{ steps.filter.outputs.tier0 }}
      tier1: ${{ steps.filter.outputs.tier1 }}
      tier2: ${{ steps.filter.outputs.tier2 }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            base:
              - 'base/**'
            tier0:
              - 'tier0/**'
            tier1:
              - 'tier1/**'
            tier2:
              - 'tier2/**'
            workflows:
              - '.github/workflows/**'

  build-base:
    needs: [normalize, detect-changes]
    # Build if base changed, or if workflows changed, or if scheduled/manual
    if: |
      needs.detect-changes.outputs.base == 'true' ||
      needs.detect-changes.outputs.workflows == 'true' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    with:
      image-name: ultramarine
      flavor: base

  # todo: maybe tier0 for desktop base images?
  #
  build-tier0:
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    needs: [normalize, detect-changes, build-base]
    if: |
      !cancelled() &&
      needs.build-base.result != 'failure' &&
      (needs.build-base.result == 'success' ||
      needs.detect-changes.outputs.base == 'true' ||
      needs.detect-changes.outputs.tier0 == 'true' ||
      needs.detect-changes.outputs.workflows == 'true' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch')
    strategy:
      fail-fast: false
      matrix:
        flavor:
          - desktop
    with:
      image-name: ultramarine-tier0
      flavor: ${{ matrix.flavor }}
      context-path: tier0/${{ matrix.flavor }}
      from: >-
        ${{
          needs.build-base.result == 'success' &&
          needs.build-base.outputs.manifest ||
          format('{0}/base-bootc:{1}', needs.normalize.outputs.registry, needs.normalize.outputs.tag)
        }}

  tier0-outputs:
    needs: [build-tier0]
    runs-on: ubuntu-latest
    if: |
      !cancelled() && needs.build-tier0.result == 'success'
    outputs:
      result: "${{ steps.read.outputs.result }}"
    steps:
      - uses: cloudposse/github-action-matrix-outputs-read@v1
        id: read
        with:
          matrix-step-name: ultramarine-tier0

  build-tier1:
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    needs: [normalize, detect-changes, build-tier0, tier0-outputs]
    if: |
      !cancelled() &&
      needs.build-tier0.result != 'failure' &&
      needs.tier0-outputs.result != 'failure' &&
      (needs.build-tier0.result == 'success' ||
      needs.detect-changes.outputs.base == 'true' ||
      needs.detect-changes.outputs.tier0 == 'true' ||
      needs.detect-changes.outputs.tier1 == 'true' ||
      needs.detect-changes.outputs.workflows == 'true' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch')
    strategy:
      fail-fast: false
      matrix:
        flavor:
          - gnome
          - xfce
          - plasma
          - budgie
    with:
      image-name: ultramarine-tier1
      flavor: ${{ matrix.flavor }}
      context-path: tier1/${{ matrix.flavor }}
      from: >-
        ${{
          needs.tier0-outputs.result == 'success' &&
          fromJson(needs.tier0-outputs.outputs.result).manifest.desktop ||
          format('{0}/desktop-bootc:{1}', needs.normalize.outputs.registry, needs.normalize.outputs.tag)
        }}

  tier1-outputs:
    needs: [build-tier1]
    runs-on: ubuntu-latest
    if: |
      !cancelled() && needs.build-tier1.result == 'success'
    outputs:
      result: "${{ steps.read.outputs.result }}"
    steps:
      - uses: cloudposse/github-action-matrix-outputs-read@v1
        id: read
        with:
          matrix-step-name: ultramarine-tier1

  # Extra tiers for HWE variants, etc.
  build-tier2:
    uses: ./.github/workflows/reusable-build-image.yml
    secrets: inherit
    needs: [normalize, detect-changes, build-tier1, tier1-outputs]
    if: |
      !cancelled() &&
      (needs.build-tier1.result == 'success' || needs.build-tier1.result == 'skipped') &&
      (needs.tier1-outputs.result == 'success' || needs.tier1-outputs.result == 'skipped') &&
      (needs.build-tier1.result == 'success' ||
      needs.detect-changes.outputs.base == 'true' ||
      needs.detect-changes.outputs.tier0 == 'true' ||
      needs.detect-changes.outputs.tier1 == 'true' ||
      needs.detect-changes.outputs.tier2 == 'true' ||
      needs.detect-changes.outputs.workflows == 'true' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch')
    strategy:
      fail-fast: false
      matrix:
        base-flavor:
          - gnome
          - xfce
          - plasma
          - budgie
        variant:
          # - surface
          # - nvidia
          # - rpi
          - run0
          - steam
          - nvidia
    with:
      image-name: ultramarine-tier2
      flavor: ${{ matrix.base-flavor }}
      context-path: tier2/${{ matrix.variant }}
      platforms: >-
        ${{
        matrix.variant == 'rpi' && 'linux/arm64' ||
        matrix.variant == 'steam' && 'linux/amd64' ||
        'linux/amd64,linux/arm64'
        }}
      from: >-
        ${{
          needs.tier1-outputs.result == 'success' &&
          fromJson(needs.tier1-outputs.outputs.result).manifest[matrix.base-flavor] ||
          format('{0}/{1}-bootc:{2}', needs.normalize.outputs.registry, matrix.base-flavor, needs.normalize.outputs.tag)
        }}
      tag-suffix: "-${{ matrix.variant }}"

  tier2-outputs:
    needs: [build-tier2]
    runs-on: ubuntu-latest
    if: needs.build-tier2.result == 'success'
    outputs:
      result: "${{ steps.read.outputs.result }}"
    steps:
      - uses: cloudposse/github-action-matrix-outputs-read@v1
        id: read
        with:
          matrix-step-name: ultramarine-tier2
