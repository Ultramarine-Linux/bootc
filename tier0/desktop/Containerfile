FROM ghcr.io/ultramarine-linux/base-bootc:main

COPY . /usr/src/ultramarine-bootc/tier0/desktop
COPY systemd/flatpak-add-flathub-repos.service /usr/lib/systemd/system/flatpak-add-flathub-repos.service
COPY 20-rhgb.toml /usr/lib/bootc/kargs.d/
COPY systemd/packagekit.service.d /usr/lib/systemd/system/packagekit.service.d/

RUN setfattr -n user.component -v "ultramarine-desktop" /usr/lib/bootc/kargs.d/20-rhgb.toml && \
    setfattr -n user.component -v "ultramarine-desktop" /usr/lib/systemd/system/flatpak-add-flathub-repos.service && \
    setfattr -n user.component -v "ultramarine-desktop" /usr/lib/systemd/system/packagekit.service.d && \
    setfattr -n user.component -v "ultramarine-desktop-config" /usr/src/ultramarine-bootc/tier0/desktop

RUN --mount=type=cache,target=/var/cache dnf do -y \
    --no-best \
    --allowerasing \
    --action install \
    taidan \
    readymade \
    readymade-config-ultramarine \
    @multimedia \
    @ultramarine-product-common \
    plymouth \
    livesys-scripts \
    isomd5sum \
    orca \
    espeak-ng \
    speech-dispatcher-espeak-ng \
    mkfstab \
    um \
    moby-engine \
    docker-compose \
    podman \
    container-selinux \
    dive \
    dracut-live \
    dracut-network \
    ultramarine-repos-extras \
    dracut-strip-trigger \
    PackageKit \
    fuse-libs \
    PackageKit-bootc \
    tuned-ppd \
    powertop \
    tuned-profiles-atomic \
    plymouth-system-theme \
    @base-graphical && \
    dnf clean all


RUN plymouth-set-default-theme bgrt

COPY desktop.sh /tmp/desktop.sh

RUN --mount=type=cache,target=/var/cache sh -c '/tmp/desktop.sh && rm -f /tmp/desktop.sh'

COPY live-setup.sh /tmp/live-setup.sh

RUN chmod +x /tmp/live-setup.sh && \
    sh -c '/tmp/live-setup.sh && rm -f /tmp/live-setup.sh'
